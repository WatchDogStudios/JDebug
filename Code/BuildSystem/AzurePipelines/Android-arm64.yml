trigger:
  branches:
    include:
    - dev

resources:
  repositories:
  - repository: self
    type: git
    ref: dev

jobs:
- job: Android_arm64
  displayName: Android-arm64
  timeoutInMinutes: 180
  pool:
    name: Default
    demands:
    - Agent.OS -equals Linux
    - GPU

  steps:
  - checkout: self
    submodules: true
    lfs: true
    clean: false

  - task: PowerShell@2
    displayName: Check force clean
    inputs:
      targetType: inline
      script: |
        $pathA = Join-Path $(System.DefaultWorkingDirectory) "gitClean.txt"
        $pathB = Join-Path $(System.DefaultWorkingDirectory) "gitCleanCopy.txt"
        $clean = -not (Test-Path $pathB) -or (compare-object (get-content $pathA) (get-content $pathB))
        if ($clean)
        {
            Write-Host "Cleaning repo!"
            git clean -dfx
            Copy-Item -Path $pathA -Destination $pathB
        }
        
  - task: CMake@1
    displayName: CMake linux-clang-dev
    inputs:
      cwd: $(System.DefaultWorkingDirectory)
      cmakeArgs: --preset linux-clang-dev

  - task: CMake@1
    displayName: CMake build linux-clang-dev
    inputs:
      cwd: $(System.DefaultWorkingDirectory)/Workspace/linux-clang-dev
      cmakeArgs: --build . --target ShaderCompiler --config dev

  - task: PowerShell@2
    displayName: Compile Shaders
    inputs:
      targetType: inline
      errorActionPreference: 'stop'
      failOnStderr: true
      script: |
        Set-StrictMode -Version Latest   
        cd $(System.DefaultWorkingDirectory)/Output/Bin/LinuxNinjaClangDev64
        ./nsShaderCompiler -renderer Vulkan -platform VULKAN -project $(System.DefaultWorkingDirectory)/Data/Base -shader Shaders/Pipeline
        if ($LASTEXITCODE -ne 0) { throw "Error compiling Base shaders" }
        ./nsShaderCompiler -renderer Vulkan -platform VULKAN -project $(System.DefaultWorkingDirectory)/Data/UnitTests -shader RendererTest/Shaders
        if ($LASTEXITCODE -ne 0) { throw "Error compiling UnitTests shaders" }
        ./nsShaderCompiler -renderer Vulkan -platform VULKAN -project $(System.DefaultWorkingDirectory)/Data/Samples/ShaderExplorer -shader Shaders
        if ($LASTEXITCODE -ne 0) { throw "Error compiling ShaderExplorer shaders" }

  - task: CMake@1
    displayName: CMake android-arm64-dev
    inputs:
      cwd: $(System.DefaultWorkingDirectory)
      cmakeArgs: --preset android-arm64-dev

  - task: PowerShell@2
    displayName: Build
    inputs:
      targetType: inline
      script: ninja -C Workspace/android-arm64-dev
...
